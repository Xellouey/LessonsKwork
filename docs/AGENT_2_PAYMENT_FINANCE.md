# –§–ê–ó–ê 2: Payment & Finance Development

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏
–í—ã - Agent 2, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Telegram Stars, –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–µ–π –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å. –í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Agent 1 (Backend Core).

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
‚úÖ Agent 1 –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É –∏ —Å–æ–∑–¥–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é `BACKEND_CORE_COMPLETE.md`  
‚úÖ Backend API –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:8000`  
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —Å –º–æ–¥–µ–ª—è–º–∏ `Purchase`, `User`, `Lesson`, `Course`  
‚úÖ API endpoints –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Ä–æ–∫–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç  

## –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Telegram Stars, –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤, —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é –∏ –≤—ã–≤–æ–¥–æ–º —Å—Ä–µ–¥—Å—Ç–≤.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ—Ü–µ—Å—Å—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤—ã –î–û–õ–ñ–ù–´ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. **Sequential Thinking** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞:
   - –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ sequential thinking –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–¥–∞—á–∏
   - –†–∞–∑–±–µ–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
   - –ü—Ä–æ–¥—É–º–∞–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ö–æ–¥–∞ –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π

2. **Context7** - –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä–æ–≤:
   - –ò—â–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ Telegram Stars API
   - –ò–∑—É—á–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
   - –ù–∞—Ö–æ–¥–∏—Ç–µ best practices –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
   - –ò—â–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –∏ —Å–∫–∏–¥–∫–∞–º–∏

**–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã**: Sequential Thinking ‚Üí Context7 Research ‚Üí Implementation ‚Üí Testing

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Python Telegram Bot API**: –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- **Telegram Stars API**: –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **SQLAlchemy**: –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **Celery**: –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **Logging**: –¥–ª—è –∞—É–¥–∏—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```
# –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É .env —Ñ–∞–π–ª—É
TELEGRAM_PAYMENT_PROVIDER_TOKEN=your-payment-provider-token
WEBHOOK_URL=https://your-domain.com/webhook
TELEGRAM_STARS_WEBHOOK_SECRET=your-webhook-secret
FINANCIAL_REPORT_EMAIL=admin@example.com
WITHDRAW_MIN_AMOUNT=1000
COMMISSION_PERCENT=5
```

## –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –®–∞–≥ 1: –ò–∑—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (30 –º–∏–Ω)

**üß† –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Sequential Thinking –¥–ª—è:**
- –ê–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Backend Core –æ—Ç Agent 1
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ API
- –í—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**üìö –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram Stars API
- –ü—Ä–∏–º–µ—Ä–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Å FastAPI
- Best practices –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
1. –ò–∑—É—á–∏—Ç—å `BACKEND_CORE_COMPLETE.md` –æ—Ç Agent 1
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å API endpoints:
   - `GET /api/users/`
   - `GET /api/lessons/`
   - `POST /auth/login`
3. –ü–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥–µ–ª–µ–π `Purchase`, `User`, `Lesson`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (60 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –ê–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Telegram Payment API documentation
- Python libraries –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- –ü—Ä–∏–º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### –°–æ–∑–¥–∞—Ç—å `backend/services/payment_service.py`:
```python
class PaymentService:
    def create_payment(self, user_id: int, item_id: int, item_type: str, promo_code: str = None)
    def verify_payment(self, payment_id: str, telegram_payment_data: dict)
    def process_successful_payment(self, purchase_id: int)
    def handle_failed_payment(self, purchase_id: int, error: str)
    def apply_promo_code(self, code: str, amount: int) -> int
    def get_user_purchases(self, user_id: int) -> List[Purchase]
```

#### –°–æ–∑–¥–∞—Ç—å `backend/api/payments.py`:
- `POST /api/payments/create` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `POST /api/payments/webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Telegram
- `GET /api/payments/{payment_id}` - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- `POST /api/payments/verify` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
- `GET /api/payments/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars (90 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü–æ–Ω–∏–º–∞–Ω–∏—è workflow Telegram Stars –ø–ª–∞—Ç–µ–∂–µ–π
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤
- –ê–Ω–∞–ª–∏–∑–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Telegram Stars API complete guide
- Webhook handling best practices
- Python telegram bot payment examples

#### –°–æ–∑–¥–∞—Ç—å `bot/handlers/payment_handlers.py`:
```python
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ Telegram Bot
async def handle_pre_checkout_query(update: Update, context: ContextTypes.DEFAULT_TYPE)
async def handle_successful_payment(update: Update, context: ContextTypes.DEFAULT_TYPE)
async def send_invoice(update: Update, context: ContextTypes.DEFAULT_TYPE, lesson_id: int)
async def create_course_invoice(update: Update, context: ContextTypes.DEFAULT_TYPE, course_id: int)
```

#### –°–æ–∑–¥–∞—Ç—å `bot/utils/payment_utils.py`:
```python
def create_invoice_payload(user_id: int, item_id: int, item_type: str) -> str
def parse_invoice_payload(payload: str) -> dict
def calculate_final_price(base_price: int, promo_code: str = None) -> int
def format_price_message(price: int, currency: str = "XTR") -> str
```

### –®–∞–≥ 4: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (45 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–∏–±–∫–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–∫–∏–¥–æ–∫
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –ê–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–¥–æ–≤

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Promo code system design patterns
- Database optimization for discount systems
- Security best practices for promotional codes

#### –†–∞—Å—à–∏—Ä–∏—Ç—å `backend/services/promo_service.py`:
```python
class PromoCodeService:
    def validate_promo_code(self, code: str) -> PromoCode
    def apply_discount(self, promo_code: PromoCode, amount: int) -> int
    def use_promo_code(self, code: str, user_id: int) -> bool
    def get_active_promocodes(self) -> List[PromoCode]
    def create_promo_code(self, code: str, discount_percent: int, max_uses: int) -> PromoCode
```

#### –°–æ–∑–¥–∞—Ç—å API endpoints –≤ `backend/api/promocodes.py`:
- `GET /api/promocodes/` - —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- `POST /api/promocodes/` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `PUT /api/promocodes/{code}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `DELETE /api/promocodes/{code}` - –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `POST /api/promocodes/validate` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

### –®–∞–≥ 5: –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å (60 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –ê–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç—á–µ—Ç–æ–≤

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Financial reporting system design
- Data aggregation patterns in Python
- Dashboard and analytics best practices

#### –°–æ–∑–¥–∞—Ç—å `backend/services/finance_service.py`:
```python
class FinanceService:
    def get_daily_revenue(self, date: date) -> dict
    def get_monthly_stats(self, year: int, month: int) -> dict
    def get_top_selling_lessons(self, limit: int = 10) -> List[dict]
    def get_user_lifetime_value(self, user_id: int) -> float
    def export_financial_report(self, start_date: date, end_date: date) -> str
    def calculate_withdrawable_amount(self) -> int
```

#### –°–æ–∑–¥–∞—Ç—å API endpoints –≤ `backend/api/finance.py`:
- `GET /api/finance/daily/{date}` - –¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /api/finance/monthly/{year}/{month}` - –º–µ—Å—è—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /api/finance/top-lessons` - —Ç–æ–ø –ø—Ä–æ–¥–∞–∂
- `GET /api/finance/export` - —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
- `POST /api/finance/withdraw` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

### –®–∞–≥ 6: –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ (45 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
- –ê–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –æ–¥–æ–±—Ä–µ–Ω–∏—é
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –≤—ã–≤–æ–¥–∞

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Withdrawal system security patterns
- Telegram Wallet integration examples
- Financial transaction approval workflows

#### –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `WithdrawRequest` –≤ `shared/models.py`:
```python
class WithdrawRequest(Base):
    id: int (Primary Key)
    amount: int
    status: str (pending, approved, completed, rejected)
    telegram_wallet_address: str
    requested_at: datetime
    processed_at: datetime (Nullable)
    notes: text (Nullable)
```

#### –°–æ–∑–¥–∞—Ç—å `backend/services/withdraw_service.py`:
```python
class WithdrawService:
    def create_withdraw_request(self, amount: int, wallet_address: str) -> WithdrawRequest
    def approve_withdraw(self, request_id: int) -> bool
    def process_withdraw(self, request_id: int) -> bool
    def get_pending_withdraws(self) -> List[WithdrawRequest]
```

### –®–∞–≥ 7: –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞
- –ê–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Financial audit logging best practices
- Python logging patterns for financial systems
- Security monitoring and alerting systems

#### –°–æ–∑–¥–∞—Ç—å `backend/utils/audit_logger.py`:
```python
class AuditLogger:
    def log_payment_created(self, payment_data: dict)
    def log_payment_completed(self, payment_id: str, amount: int)
    def log_payment_failed(self, payment_id: str, error: str)
    def log_promo_code_used(self, code: str, user_id: int)
    def log_withdraw_request(self, amount: int, user: str)
```

### –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π (60 –º–∏–Ω)

**üß† Sequential Thinking –¥–ª—è:**
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è comprehensive test suite –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- –ê–Ω–∞–ª–∏–∑–∞ edge cases –∏ error scenarios
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è mock-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API

**üìö Context7 –¥–ª—è –ø–æ–∏—Å–∫–∞:**
- Payment system testing strategies
- Python testing frameworks for financial apps
- Mock testing patterns for payment APIs

#### –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –≤ `backend/tests/`:
- `test_payment_service.py` - —Ç–µ—Å—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- `test_promo_codes.py` - —Ç–µ—Å—Ç—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- `test_finance_api.py` - —Ç–µ—Å—Ç—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö API
- `test_telegram_payments.py` - –º–æ–∫-—Ç–µ—Å—Ç—ã Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏:
```python
# –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
def test_successful_lesson_purchase()
def test_course_purchase_with_promo()
def test_payment_failure_handling()
def test_duplicate_payment_prevention()
def test_withdraw_request_creation()
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è

```
backend/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ payments.py           # –ü–ª–∞—Ç–µ–∂–Ω—ã–µ API
‚îÇ   ‚îú‚îÄ‚îÄ promocodes.py         # API –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ finance.py            # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ API
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ payment_service.py    # –ü–ª–∞—Ç–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ promo_service.py      # –ü—Ä–æ–º–æ–∫–æ–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ finance_service.py    # –§–∏–Ω–∞–Ω—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ withdraw_service.py   # –í—ã–≤–æ–¥—ã
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ test_payment_service.py
    ‚îú‚îÄ‚îÄ test_promo_codes.py
    ‚îú‚îÄ‚îÄ test_finance_api.py
    ‚îî‚îÄ‚îÄ test_telegram_payments.py

bot/
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ payment_handlers.py   # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ payment_utils.py      # –£—Ç–∏–ª–∏—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π

shared/
‚îú‚îÄ‚îÄ models.py                 # –î–æ–±–∞–≤–∏—Ç—å WithdrawRequest
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ audit_logger.py       # –ê—É–¥–∏—Ç –ª–æ–≥–∏
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ API —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç  
‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞  
‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞  
‚úÖ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞  
‚úÖ –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç > 85% –∫–æ–¥–∞ –º–æ–¥—É–ª—è  

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:
```bash
# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
curl -X POST "http://localhost:8000/api/payments/create" \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1, "lesson_id": 1, "promo_code": "TEST10"}'

# –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
curl -X POST "http://localhost:8000/api/promocodes/validate" \
  -H "Content-Type: application/json" \
  -d '{"code": "TEST10", "amount": 100}'

# –¢–µ—Å—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
curl -X GET "http://localhost:8000/api/finance/daily/2024-01-01" \
  -H "Authorization: Bearer YOUR_TOKEN"

# –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest backend/tests/test_payment_service.py -v
```

## –§–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–∑–¥–∞–π—Ç–µ `docs/agents/PAYMENT_FINANCE_COMPLETE.md`:

### –†–∞–∑–¥–µ–ª 1: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- API endpoints –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã –∏ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –†–∞–∑–¥–µ–ª 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

#### –î–ª—è Agent 3 (User Interface):
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
payment_data = {
    "user_id": telegram_user.id,
    "lesson_id": lesson.id,
    "promo_code": user_promo_code  # optional
}
response = requests.post("/api/payments/create", json=payment_data)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
purchases = requests.get(f"/api/users/{user_id}/purchases")
```

#### –î–ª—è Agent 4 (Administration):
```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
daily_stats = requests.get("/api/finance/daily/2024-01-01")
monthly_stats = requests.get("/api/finance/monthly/2024/1")

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
promo_data = {
    "code": "NEWUSER20",
    "discount_percent": 20,
    "max_uses": 100
}
requests.post("/api/promocodes/", json=promo_data)
```

#### –î–ª—è Agent 5 (Communication):
```python
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
payment_notifications = {
    "successful_payment": "‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!",
    "failed_payment": "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞",
    "promo_applied": "üéâ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞: {discount}%"
}
```

### –†–∞–∑–¥–µ–ª 3: Webhook Configuration
```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –¥–ª—è Telegram
WEBHOOK_CONFIG = {
    "url": "https://your-domain.com/api/payments/webhook",
    "secret_token": "your-webhook-secret",
    "allowed_updates": ["pre_checkout_query", "message"]
}
```

### –†–∞–∑–¥–µ–ª 4: –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```sql
-- –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
INSERT INTO promocodes (code, discount_percent, max_uses, is_active) 
VALUES ('TEST10', 10, 100, true);

-- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏
INSERT INTO purchases (user_id, lesson_id, amount, status) 
VALUES (1, 1, 100, 'completed');
```

### –†–∞–∑–¥–µ–ª 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ –¥–æ—Ö–æ–¥–∞–º

### –†–∞–∑–¥–µ–ª 6: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è webhook signatures
- Rate limiting –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö API
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤

### Agent 3 (User Interface):
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã –≤ Telegram Bot
- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö

### Agent 4 (Administration):
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤

### Agent 5 (Communication):
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
- –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∏ –æ –Ω–æ–≤—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ –ø–ª–∞—Ç–µ–∂–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º

**–í–∞–∂–Ω–æ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ webhook –æ—Ç Telegram –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!